#!/bin/bash -euo pipefail
# Crash Investigation Monitor - logs system state every minute
# Managed by Ansible - do not edit manually

LOG_DIR="/var/log/crash-monitor"
LOG_FILE="$LOG_DIR/$(date +%Y-%m-%d).log"

{
  echo "=== $(date +%Y-%m-%dT%H:%M:%S) ==="

  echo "--- Memory ---"
  free -m

  echo "--- Swap Usage ---"
  grep -E "^(Swap|Mem|Buffers|Cached|Active|Inactive|Dirty)" /proc/meminfo

  echo "--- Top 10 Memory Users ---"
  ps aux --sort=-%mem | head -11

  echo "--- Load ---"
  uptime

  echo "--- VM/CT Count ---"
  echo "Running VMs: $(qm list 2>/dev/null | grep -c running || echo 0)"
  echo "Running CTs: $(pct list 2>/dev/null | grep -c running || echo 0)"

  # ==========================================================================
  # HARDWARE ERROR MONITORING (MCE/EDAC)
  # ==========================================================================

  echo "--- EDAC Memory Errors ---"
  # Check for correctable errors (early warning signs)
  CE_TOTAL=0
  UE_TOTAL=0
  if [ -d /sys/devices/system/edac/mc ]; then
    for mc in /sys/devices/system/edac/mc/mc*; do
      if [ -d "$mc" ]; then
        mc_name=$(basename "$mc")
        ce_count=$(cat "$mc/ce_count" 2>/dev/null || echo 0)
        ue_count=$(cat "$mc/ue_count" 2>/dev/null || echo 0)
        CE_TOTAL=$((CE_TOTAL + ce_count))
        UE_TOTAL=$((UE_TOTAL + ue_count))
        # Only log if there are errors
        if [ "$ce_count" -gt 0 ] || [ "$ue_count" -gt 0 ]; then
          echo "  $mc_name: CE=$ce_count UE=$ue_count"
        fi
      fi
    done
  fi
  echo "  TOTAL: Correctable=$CE_TOTAL Uncorrectable=$UE_TOTAL"

  # Alert on uncorrectable errors (these are serious)
  if [ "$UE_TOTAL" -gt 0 ]; then
    echo "  WARNING: Uncorrectable memory errors detected!"
  fi

  echo "--- Recent MCE Events (last hour) ---"
  # Check for recent Machine Check Exception events in journal
  MCE_COUNT=$(journalctl --since="1 hour ago" -g "mce|machine check" 2>/dev/null | wc -l || echo 0)
  echo "  MCE events in last hour: $MCE_COUNT"
  if [ "$MCE_COUNT" -gt 0 ]; then
    echo "  WARNING: Recent MCE hardware errors detected!"
    journalctl --since="1 hour ago" -g "mce|machine check" 2>/dev/null | tail -5 || true
  fi

  echo "--- CPU Throttling ---"
  # Check if CPUs are being throttled (thermal or power)
  THROTTLE_COUNT=0
  for cpu in /sys/devices/system/cpu/cpu*/thermal_throttle/core_throttle_count; do
    if [ -f "$cpu" ]; then
      count=$(cat "$cpu" 2>/dev/null || echo 0)
      THROTTLE_COUNT=$((THROTTLE_COUNT + count))
    fi
  done
  echo "  Total throttle events: $THROTTLE_COUNT"

  echo "--- Temperature ---"
  # Log CPU/system temperatures if sensors available
  if command -v sensors &>/dev/null; then
    sensors 2>/dev/null | grep -E "^(Core|CPU|Tctl|Package)" | head -10 || echo "  No temp sensors"
  else
    echo "  sensors not available"
  fi

  echo ""
} >> "$LOG_FILE" 2>&1

# Rotate: keep only last {{ proxmox_monitoring_log_retention_days }} days
find "$LOG_DIR" -name "*.log" -mtime +{{ proxmox_monitoring_log_retention_days }} -delete 2>/dev/null
