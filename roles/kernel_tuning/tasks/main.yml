---
# Kernel Tuning role tasks

- name: Configure kernel tuning parameters
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: "{{ kernel_tuning_sysctl_file }}"
    reload: true
    state: present
  loop:
    - name: vm.swappiness
      value: "{{ kernel_tuning_swappiness }}"
    - name: vm.vfs_cache_pressure
      value: "{{ kernel_tuning_vfs_cache_pressure }}"
    - name: vm.dirty_ratio
      value: "{{ kernel_tuning_dirty_ratio }}"
    - name: vm.dirty_background_ratio
      value: "{{ kernel_tuning_dirty_background_ratio }}"
    - name: vm.overcommit_memory
      value: "{{ kernel_tuning_overcommit_memory }}"
  tags:
    - kernel_tuning
    - sysctl

# ------------------------------------------------------------------------------
# Proxmox Boot Parameters
# Uses /etc/kernel/cmdline + proxmox-boot-tool (NOT grub)
# ------------------------------------------------------------------------------

- name: Manage Proxmox boot parameters
  when: kernel_tuning_boot_params_enabled | default(false)
  tags:
    - kernel_tuning
    - boot_params
    - proxmox
  block:
    - name: Check if /etc/kernel/cmdline exists
      ansible.builtin.stat:
        path: /etc/kernel/cmdline
      register: kernel_tuning_cmdline_stat
      failed_when: false
      changed_when: false

    - name: Skip boot parameter management if /etc/kernel/cmdline does not exist
      ansible.builtin.debug:
        msg: "Boot parameter management skipped: /etc/kernel/cmdline not found (requires Proxmox)"
      when: not kernel_tuning_cmdline_stat.stat.exists

    - name: Read current kernel cmdline
      ansible.builtin.slurp:
        src: /etc/kernel/cmdline
      register: kernel_tuning_current_cmdline
      when: kernel_tuning_cmdline_stat.stat.exists

    - name: Parse base boot parameters
      ansible.builtin.set_fact:
        kernel_tuning_base_params: >-
          {{ (kernel_tuning_current_cmdline.content | b64decode | trim).split()
             | reject('match', '^(nmi_watchdog|softlockup_panic|hung_task_panic|mce|edac_report|crashkernel|clocksource|tsc)(=.*)?$')
             | reject('match', '^nosmt$')
             | list
             | join(' ') }}
      when: kernel_tuning_cmdline_stat.stat.exists

    - name: Build stability parameters
      ansible.builtin.set_fact:
        kernel_tuning_stability_params: >-
          {{ (['clocksource=' ~ kernel_tuning_clocksource,
              'tsc=' ~ kernel_tuning_tsc_mode,
              'nmi_watchdog=' ~ kernel_tuning_nmi_watchdog,
              'softlockup_panic=' ~ kernel_tuning_softlockup_panic,
              'hung_task_panic=' ~ kernel_tuning_hung_task_panic,
              'mce=' ~ kernel_tuning_mce_level,
              'edac_report=' ~ kernel_tuning_edac_report]
             + (['crashkernel=' ~ kernel_tuning_crashkernel] if (kernel_tuning_manage_crashkernel | default(false)) else []))
             | select('defined')
             | list + (['nosmt'] if kernel_tuning_disable_smt else [])
             | join(' ') }}
      when: kernel_tuning_cmdline_stat.stat.exists

    - name: Build complete cmdline
      ansible.builtin.set_fact:
        kernel_tuning_new_cmdline: >-
          {{ kernel_tuning_base_params }}
          {{ kernel_tuning_stability_params | regex_replace('\s+', ' ') | trim }}
      when: kernel_tuning_cmdline_stat.stat.exists

    - name: Display planned cmdline change
      ansible.builtin.debug:
        msg: |
          Current: {{ kernel_tuning_current_cmdline.content | b64decode | trim }}
          New:     {{ kernel_tuning_new_cmdline }}
      changed_when: false
      when: kernel_tuning_cmdline_stat.stat.exists

    - name: Write new kernel cmdline
      ansible.builtin.copy:
        content: "{{ kernel_tuning_new_cmdline }}\n"
        dest: /etc/kernel/cmdline
        owner: root
        group: root
        mode: "0644"
        backup: true
      register: kernel_tuning_cmdline_result
      notify: Refresh proxmox boot
      when: kernel_tuning_cmdline_stat.stat.exists
